window.CallPower=_.extend(window.CallPower,{Models:{},Collections:{},Views:{},init:function(){console.log('Call Power');this.campaignForm=new CallPower.Views.CampaignForm();}});window.renderTemplate=function(selector,context){var template=_.template($('script[type="text/template"]'+selector).html(),{'variable':'data'});return $(template(context));};$(document).ready(function(){CallPower.init();});(function(){CallPower.Views.CampaignForm=Backbone.View.extend({el:$('form#campaign'),events:{'click a.radio-inline.clear':'clearRadioChoices','change select#campaign_type':'changeCampaignType','change input[name="segment_by"]':'changeSegmentBy','change input[name="call_limit"]':'changeCallLimit','submit form':'validateForm'},initialize:function(){console.log('render CampaignForm start');this.searchForm=new CallPower.Views.TargetSearch();this.targetListView=new CallPower.Views.TargetList();if(!$('select.nested').val()){$('select.nested').empty();}
this.changeCampaignType();this.changeSegmentBy();console.log('render CampaignForm end');},changeCampaignType:function(){var field=$('select#campaign_type');var val=field.val();var nested_field=$('select#campaign_subtype');var nested_choices=nested_field.data('nested-choices');var nested_val=nested_field.val();nested_field.empty();var avail=_.find(nested_choices,function(v){return v[0]==val;})[1];_.each(avail,function(v){var option=$('<option value="'+v[0]+'">'+v[1]+'</option>');nested_field.append(option);});if(_.contains(_.flatten(avail),nested_val)){nested_field.val(nested_val);}else{nested_field.val('');}
if(avail.length===0){nested_field.prop('disabled',true);}else{nested_field.prop('disabled',false);}
if(val==='state'){$('select[name="campaign_state"]').show();$('#target-search input[name="target-search"]').attr('placeholder','search OpenStates');}else{$('select[name="campaign_state"]').hide();$('#target-search input[name="target-search"]').attr('placeholder','search Sunlight');}
if(val==="custom"||val==="local"){$('#target-search input[name="target-search"]').attr('disabled',true);$('#target-search button.search').attr('disabled',true);$('#set-targets').show();}else{$('#target-search input[name="target-search"]').attr('disabled',false);$('#target-search button.search').attr('disabled',false);var segment_by=$('input[name="segment_by"]:checked');if(segment_by.val()!=='custom'){$('#set-targets').hide();}}},clearRadioChoices:function(event){var buttons=$(event.target).parent().find('input[type="radio"]');buttons.attr('checked',false).trigger('change');},changeSegmentBy:function(){var selected=$('input[name="segment_by"]:checked');if(selected.val()!=="custom"){$('#set-targets').hide();}else{$('#set-targets').show();}},changeCallLimit:function(event){var callMaxGroup=$('input[name="call_maximum"]').parents('.form-group');if($(event.target).prop('checked')){callMaxGroup.show();}else{callMaxGroup.hide();$('input[name="call_maximum"]').val('');}},validateForm:function(event){event.preventDefault();return false;}});})();(function(){CallPower.Views.TargetSearch=Backbone.View.extend({el:$('div#target-search'),events:{'keydown input[name="target-search"]':'searchKey','focusout input[name="target-search"]':'searchTab','click .search':'doTargetSearch','click .search-results .result':'selectSearchResult','click .search-results .close':'closeSearch',},initialize:function(){console.log('SearchForm initialize');},searchKey:function(event){if(event.which===13){event.preventDefault();this.doTargetSearch();}},searchTab:function(event){},doTargetSearch:function(event){var self=this;var query=$('input[name="target-search"]').val();console.log('search '+query);var campaign_type=$('select[name="campaign_type"]').val();var campaign_state=$('select[name="campaign_state"]').val();var chamber=$('select[name="campaign_subtype"]').val();if(campaign_type==='congress'){$.ajax({url:CallPower.Config.SUNLIGHT_CONGRESS_URL,data:{apikey:CallPower.Config.SUNLIGHT_API_KEY,in_office:true,chamber:chamber,query:query},beforeSend:function(jqXHR,settings){console.log(settings.url);},success:self.renderSearchResults,error:self.errorSearchResults,});}
if(campaign_type==='state'){$.ajax({url:CallPower.Config.SUNLIGHT_STATES_URL,data:{apikey:CallPower.Config.SUNLIGHT_API_KEY,state:campaign_state,in_office:true,chamber:chamber,last_name:query},beforeSend:function(jqXHR,settings){console.log(settings.url);},success:self.renderSearchResults,error:self.errorSearchResults,});}},renderSearchResults:function(response){var results;if(response.results){results=response.results;}else{results=response;}
var dropdownMenu=renderTemplate("#search-results-dropdown-tmpl");if(results.length===0){dropdownMenu.append('<li class="result close"><a>No results</a></li>');}
_.each(results,function(person){if(person.title==='Sen'){person.title='Senator';}
if(person.title==='Rep'){person.title='Representative';}
var li=renderTemplate("#search-results-item-tmpl",person);if(person.phone===undefined&&person.offices){if(person.offices){li.find('span.phone').html(person.offices[0].phone);}}
dropdownMenu.append(li);});$('.input-group .search-results').append(dropdownMenu);},errorSearchResults:function(response){console.log(response);},closeSearch:function(){var dropdownMenu=$('.search-results .dropdown-menu').remove();},selectSearchResult:function(event){var obj=$(event.target).data('object');CallPower.campaignForm.targetListView.collection.add(obj);if($('.search-results .dropdown-menu').children('.result').length<=1){this.closeSearch();}},});})();(function(){CallPower.Models.Target=Backbone.Model.extend({defaults:{id:null,title:null,name:null,number:null,order:null},});CallPower.Collections.TargetList=Backbone.Collection.extend({model:CallPower.Models.Target,});CallPower.Views.TargetItemView=Backbone.View.extend({tagName:'li',className:'list-group-item target',initialize:function(){this.template=_.template($('#target-item-tmpl').html(),{'variable':'data'});},render:function(){var html=this.template(this.model.toJSON());this.$el.html(html);return this;},events:{'keydown [contenteditable]':'onEdit','blur [contenteditable]':'onSave','click .remove':'onRemove',},onEdit:function(event){var target=$(event.target);var esc=event.which==27,nl=event.which==13;if(esc){document.execCommand('undo');target.blur();}else if(nl){event.preventDefault();target.blur();}else if(target.text()===target.attr('placeholder')){target.text('');target.removeClass('placeholder');}},onSave:function(event){console.log(event.target);var field=$(event.target);if(field.text()===''){field.text(field.attr('placeholder'));}
if(field.text()===field.attr('placeholder')){field.addClass('placeholder');return;}
var fieldName=field.data('field');this.model.set(fieldName,field.text());field.removeClass('placeholder');},onRemove:function(event){this.model.destroy();},});CallPower.Views.TargetList=Backbone.View.extend({el:'#set-targets',initialize:function(){this.collection=new CallPower.Collections.TargetList();this.listenTo(this.collection,'add change remove sort',this.render);$('.target-list.sortable').sortable({items:'li',handle:'.handle',}).bind('sortupdate',this.onReorder);},render:function(){var $list=this.$('ol.target-list').empty().show();this.collection.each(function(model){var item=new CallPower.Views.TargetItemView({model:model,attributes:{'data-cid':model.cid}});var $el=item.render().$el;_.each(model.attributes,function(val,key){if(val===null){var sel='span[data-field="'+key+'"]';var span=$el.children(sel);var pl=span.attr('placeholder');span.text(pl).addClass('placeholder');}});$list.append($el);},this);$('.target-list.sortable').sortable('update');return this;},events:{'click .add':'onAdd',},onAdd:function(){console.log('onAdd');var item=this.collection.add({});this.onReorder();},onReorder:function(){var view=CallPower.campaignForm.targetListView;console.log('update order');$('.target-list .list-group-item').each(function(index){var elem=$(this);var cid=elem.data('cid');console.log(cid);var item=view.collection.get(cid);if(item){item.set('order',index);}});},});})();