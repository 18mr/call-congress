window.CallPower=_.extend(window.CallPower||{},{Models:{},Collections:{},Views:{},Routers:{},init:function(){console.log('Call Power');new this.Routers.Campaign({});}});window.renderTemplate=function(selector,context){var template=_.template($('script[type="text/template"]'+selector).html(),{'variable':'data'});return $(template(context));};$(document).ready(function(){CallPower.init();Backbone.history.start({pushState:true,root:"/admin/"});});(function(){CallPower.Views.CampaignForm=Backbone.View.extend({el:$('form#campaign'),events:{'click a.radio-inline.clear':'clearRadioChoices','change select#campaign_type':'changeCampaignType','change select#campaign_subtype':'changeCampaignType','change input[name="segment_by"]':'changeSegmentBy','change input[name="call_limit"]':'changeCallLimit','submit':'submitForm'},initialize:function(){this.searchForm=new CallPower.Views.TargetSearch();this.targetListView=new CallPower.Views.TargetList();if(!$('select.nested').val()){$('select.nested').empty();}
this.changeCampaignType();this.changeSegmentBy();this.targetListView.loadExistingItems();},changeCampaignType:function(){var field=$('select#campaign_type');var val=field.val();var nested_field=$('select#campaign_subtype');var nested_choices=nested_field.data('nested-choices');var nested_val=nested_field.val();nested_field.empty();var avail=_.find(nested_choices,function(v){return v[0]==val;})[1];_.each(avail,function(v){var option=$('<option value="'+v[0]+'">'+v[1]+'</option>');nested_field.append(option);});if(_.contains(_.flatten(avail),nested_val)){nested_field.val(nested_val);}else{nested_field.val('');}
if(avail.length===0){nested_field.hide();}else{nested_field.show();}
if((val==='congress'&&nested_val==='both')||(val==='state'&&nested_val==='both')){$('input[name="target_ordering"][value="senate-first"]').parent('label').show();$('input[name="target_ordering"][value="house-first"]').parent('label').show();}else{$('input[name="target_ordering"][value="senate-first"]').parent('label').hide();$('input[name="target_ordering"][value="house-first"]').parent('label').hide();}
if(val==='state'){$('select[name="campaign_state"]').show();$('#target-search input[name="target-search"]').attr('placeholder','search OpenStates');}else{$('select[name="campaign_state"]').hide();$('#target-search input[name="target-search"]').attr('placeholder','search Sunlight');}
if(val==="custom"||val==="local"){$('.form-group.segment_by').hide();$('#target-search').addClass('invisible');$('#set-targets').show();}else{$('.form-group.segment_by').show();$('#target-search').removeClass('invisible');var segment_by=$('input[name="segment_by"]:checked');if(segment_by.val()!=='other'){$('#set-targets').hide();}}},clearRadioChoices:function(event){var buttons=$(event.target).parent().find('input[type="radio"]');buttons.attr('checked',false).trigger('change');},changeSegmentBy:function(){var selected=$('input[name="segment_by"]:checked');if(selected.val()==='location'){$('.form-group.segment_location').show();}else{$('.form-group.segment_location').hide();}
if(selected.val()==="other"){$('#set-targets').show();}else{$('#set-targets').hide();}},changeCallLimit:function(event){var callMaxGroup=$('input[name="call_maximum"]').parents('.form-group');if($(event.target).prop('checked')){callMaxGroup.show();}else{callMaxGroup.hide();$('input[name="call_maximum"]').val('');}},validateNestedSelect:function(formGroup){if($('select.nested:visible').length){return!!$('select.nested option:selected').val();}else{return true;}},validateState:function(formGroup){var campaignType=$('select#campaign_type').val();if(campaignType==="state"){return!!$('select[name="campaign_state"] option:selected').val();}else{return true;}},validateSegmentBy:function(formGroup){var campaignType=$('select#campaign_type').val();if(campaignType==="custom"||campaignType==="local"){var segmentBy=$('input[name="segment_by"]:checked').val();if(segmentBy==="other"){return true;}
else{return false;}}
return true;},validateTargetList:function(formGroup){if($('select#campaign_type').val()==="custom"){return!!CallPower.campaignForm.targetListView.collection.length;}else{return true;}},validateSelected:function(formGroup){return!!$('select option:selected',formGroup).length;},validateField:function(formGroup,validator,message){var isValid=validator(formGroup);$('.help-block',formGroup).last().text((!isValid)?message:'');formGroup.parents('fieldset').find('legend').toggleClass('has-error',!isValid);formGroup.toggleClass('has-error',!isValid);return isValid;},validateForm:function(){var isValid=true;isValid=this.validateField($('.form-group.campaign_type'),this.validateState,'Select a state')&&isValid;isValid=this.validateField($('.form-group.campaign_type'),this.validateNestedSelect,'Select a sub-type')&&isValid;isValid=this.validateField($('.form-group.segment_by'),this.validateSegmentBy,'Campaign type requires custom targeting')&&isValid;isValid=this.validateField($('.form-group#set-targets'),this.validateTargetList,'Add a custom target')&&isValid;isValid=this.validateField($('.form-group.phone_number_set'),this.validateSelected,'Select a phone number')&&isValid;return isValid;},submitForm:function(event){event.preventDefault();if(this.validateForm()){this.targetListView.serialize();$(this.$el).unbind('submit').submit();return true;}
return false;}});})();(function(){CallPower.Views.MicrophoneModal=Backbone.View.extend({tagName:'div',className:'microphone modal fade',events:{'click .record':'onRecord','click .play':'onPlay','click .reset':'onReset','submit':'onSave'},initialize:function(){this.template=_.template($('#microphone-modal-tmpl').html(),{'variable':'modal'});},render:function(modal){this.modal=modal;var html=this.template(modal);console.log(html);this.$el.html(html).modal('show');return this;},onRecord:function(){},onPlay:function(){},onReset:function(){},onSave:function(){},});})();(function(){CallPower.Views.RecordForm=Backbone.View.extend({el:$('form#record'),events:{'click .record':'onRecord','click .play':'onPlay','click .upload':'onUpload','click .version':'onVersion','submit':'submitForm'},initialize:function(){console.log('record form');},onRecord:function(event){event.preventDefault();console.log('onRecord');var inputGroup=$(event.target).parents('.input-group');var modal={name:inputGroup.prev('label').text(),example_text:inputGroup.next('.description').text()};this.microphoneView=new CallPower.Views.MicrophoneModal();this.microphoneView.render(modal);},validateForm:function(){var isValid=true;return isValid;},submitForm:function(event){event.preventDefault();if(this.validateForm()){$(this.$el).unbind('submit').submit();return true;}
return false;}});})();(function(){CallPower.Routers.Campaign=Backbone.Router.extend({routes:{"campaign/create":"campaignForm","campaign/edit/:id":"campaignForm","campaign/copy/:id":"campaignForm","campaign/record/:id":"recordForm",},campaignForm:function(id){CallPower.campaignForm=new CallPower.Views.CampaignForm();},recordForm:function(id){CallPower.recordForm=new CallPower.Views.RecordForm();}});})();(function(){CallPower.Views.TargetSearch=Backbone.View.extend({el:$('div#target-search'),events:{'keydown input[name="target-search"]':'searchKey','focusout input[name="target-search"]':'searchTab','click .search':'doTargetSearch','click .search-results .result':'selectSearchResult','click .search-results .close':'closeSearch',},initialize:function(){},searchKey:function(event){if(event.which===13){event.preventDefault();this.doTargetSearch();}},searchTab:function(event){},doTargetSearch:function(event){var self=this;var query=$('input[name="target-search"]').val();var campaign_type=$('select[name="campaign_type"]').val();var campaign_state=$('select[name="campaign_state"]').val();var chamber=$('select[name="campaign_subtype"]').val();if(campaign_type==='congress'){$.ajax({url:CallPower.Config.SUNLIGHT_CONGRESS_URL,data:{apikey:CallPower.Config.SUNLIGHT_API_KEY,in_office:true,chamber:chamber,query:query},beforeSend:function(jqXHR,settings){console.log(settings.url);},success:self.renderSearchResults,error:self.errorSearchResults,});}
if(campaign_type==='state'){$.ajax({url:CallPower.Config.SUNLIGHT_STATES_URL,data:{apikey:CallPower.Config.SUNLIGHT_API_KEY,state:campaign_state,in_office:true,chamber:chamber,last_name:query},beforeSend:function(jqXHR,settings){console.log(settings.url);},success:self.renderSearchResults,error:self.errorSearchResults,});}},renderSearchResults:function(response){var results;if(response.results){results=response.results;}else{results=response;}
var dropdownMenu=renderTemplate("#search-results-dropdown-tmpl");if(results.length===0){dropdownMenu.append('<li class="result close"><a>No results</a></li>');}
_.each(results,function(person){if(person.title==='Sen'){person.title='Senator';}
if(person.title==='Rep'){person.title='Representative';}
var li=renderTemplate("#search-results-item-tmpl",person);if(person.phone===undefined&&person.offices){if(person.offices){li.find('span.phone').html(person.offices[0].phone);}}
dropdownMenu.append(li);});$('.input-group .search-results').append(dropdownMenu);},errorSearchResults:function(response){console.log(response);},closeSearch:function(){var dropdownMenu=$('.search-results .dropdown-menu').remove();},selectSearchResult:function(event){var obj=$(event.target).data('object');CallPower.campaignForm.targetListView.collection.add(obj);if($('.search-results .dropdown-menu').children('.result').length<=1){this.closeSearch();}},});})();(function(){CallPower.Models.Target=Backbone.Model.extend({defaults:{id:null,title:null,name:null,number:null,order:null},});CallPower.Collections.TargetList=Backbone.Collection.extend({model:CallPower.Models.Target,comparator:'order'});CallPower.Views.TargetItemView=Backbone.View.extend({tagName:'li',className:'list-group-item target',initialize:function(){this.template=_.template($('#target-item-tmpl').html(),{'variable':'data'});},render:function(){var html=this.template(this.model.toJSON());this.$el.attr('id','target_set-'+this.model.get('order'));this.$el.html(html);return this;},events:{'keydown [contenteditable]':'onEdit','blur [contenteditable]':'onSave','click .remove':'onRemove',},onEdit:function(event){var target=$(event.target);var esc=event.which==27,nl=event.which==13,tab=event.which==9;if(esc){document.execCommand('undo');target.blur();}else if(nl){event.preventDefault();target.blur();}else if(tab){event.preventDefault();target.next('[contenteditable]').focus();}else if(target.text()===target.attr('placeholder')){target.text('');target.removeClass('placeholder');}},onSave:function(event){var field=$(event.target);if(field.text()===''){field.text(field.attr('placeholder'));}
if(field.text()===field.attr('placeholder')){field.addClass('placeholder');return;}
var fieldName=field.data('field');this.model.set(fieldName,field.text());field.removeClass('placeholder');},onRemove:function(event){var sel='input[name^="target_set-'+this.model.get('order')+'"]';this.$el.remove(sel);this.model.destroy();},});CallPower.Views.TargetList=Backbone.View.extend({el:'#set-targets',initialize:function(){this.collection=new CallPower.Collections.TargetList();this.listenTo(this.collection,'add remove sort reset',this.render);$('.target-list.sortable').sortable({items:'li',handle:'.handle',}).bind('sortupdate',this.onSortUpdate);},loadExistingItems:function(){if(this.$el.find('input[name="target_set_length"]').val()){this.deserialize();this.recalculateOrder(this);}},render:function(){var $list=this.$('ol.target-list').empty().show();var rendered_items=[];this.collection.each(function(model){var item=new CallPower.Views.TargetItemView({model:model,attributes:{'data-cid':model.cid}});var $el=item.render().$el;_.each(model.attributes,function(val,key){if(val===null){var sel='span[data-field="'+key+'"]';var span=$el.children(sel);var pl=span.attr('placeholder');span.text(pl).addClass('placeholder');}});rendered_items.push($el);},this);$list.append(rendered_items);var target_set_errors=this.$el.find('input[name^="target_set-"]').filter('[name$="-error"]');target_set_errors.each(function(error){var id=$(this).attr('name').replace('-error','');var item=$('#'+id);item.addClass('error');var message=$(this).val();item.append('<span class="message">'+message+'</span>');});$('.target-list.sortable').sortable('update');return this;},serialize:function(){var target_set=this.$el.find('#target-set');target_set.find('input').remove('[name^="target_set-"]');this.collection.each(function(model,index){var fields=['order','title','name','number'];_.each(fields,function(field){var input=$('<input name="target_set-'+index+'-'+field+'" type="hidden" />');input.val(model.get(field));target_set.append(input);});});},deserialize:function(){var self=this;var $list=this.$('ol.target-list').empty();var target_set_length=this.$el.find('input[name="target_set_length"]').val();var items=[];_(target_set_length).times(function(n){var model=new CallPower.Models.Target();var fields=['order','title','name','number'];_.each(fields,function(field){var sel='input[name="target_set-'+n+'-'+field+'"]';var val=self.$el.find(sel).val();model.set(field,val);});items.push(model);});self.collection.reset(items);},events:{'click .add':'onAdd',},onAdd:function(){var item=this.collection.add({});this.recalculateOrder(this);},onSortUpdate:function(){var view=CallPower.campaignForm.targetListView;return view.recalculateOrder();},recalculateOrder:function(){var self=this;$('.target-list .list-group-item').each(function(index){var elem=$(this);var cid=elem.data('cid');var item=self.collection.get(cid);if(item){item.set('order',index);}});},});})();